# Flexera Policy Development - Lesson 19 - Go Template Syntax & Markdown

The `summary_template` and `detail_template` fields within a `validate` or `validate_each` block support both [Go Template Syntax](https://pkg.go.dev/text/template) and [Markdown](https://www.markdownguide.org/). This allows variables to be interpolated, text to be formatted, images to be added, and tables to be created within the incident.

Go template syntax can be used to interpolate values; the text produced by this is then interpreted as Markdown and displayed in HTML. You can typically distinguish the two by the use of `{{` and `}}`; these indicate that you're interpolating values using Go template syntax.

You've already seen some of this before with "{{ len data }}"; in this lesson, we'll add some additional Go template syntax and Markdown to the "list_policy_templates.pt" policy template.

## Step 1: Update the Version

As usual, let's update the policy template to version `0.6.0` by updating the `info` block like so:

```ruby
info(
  version: "0.6.0"
)
```

## Step 2: Applied Policy Datasource

At the beginning of the "Datasources & Scripts" section of the policy template, add the following new datasource:

```ruby
###############################################################################
# Datasources & Scripts
###############################################################################

datasource "ds_applied_policy" do
  request do
    auth $auth_flexera
    host rs_governance_host
    path join(["/api/governance/projects/", rs_project_id, "/applied_policies/", policy_id])
    header "Api-Version", "1.0"
  end
end
```

This new datasource will gather all of the metadata for the policy template as it executes. The "policy_id" reserved word will contain the id of the applied policy itself.

Note the lack of a `result` block. When there is no `result` block, the policy engine will simply assume the response is in JSON and parse the JSON as-is. You can view the structure of the JSON produced by this API request in the [Flexera Policy API Documentation](https://reference.rightscale.com/governance-policies/#/AppliedPolicy/AppliedPolicy_show).

## Step 3: Modify Summary

Next, in our `validate_each` block, modify the `summary_template` field like so:

```ruby
    summary_template "{{ with index data 0 }}{{ .policy_name }}{{ end }}: {{ len data }} Policy Templates With Lessons Found"
```

"{{ with index data 0 }}" and "{{ end }}" are Go template syntax and are used to ensure that everything between them refers to the first item in the datasource we're validating. "{{ .policy_name }}" will be replaced with the contents of the "policy_name" field of the first item in the datasource.

This pattern can be useful if you expect the user to apply a policy template multiple times. They can give each applied policy a different name, and when they review their open incidents, they will easily be able to know which incident is from which applied policy.

## Step 4: Delete Export Block

For this exercise, we're going to delete our `export` block and replace it with a table generated by Markdown. Note that you typically would not want to use a table in the `detail_template` field as a replacement for the `export` block; this is just an exercise for the sake of learning.

Modify your `validate_each` block by deleting the `export` block:

```ruby
policy "pol_list_policy_templates" do
  validate_each $ds_policy_templates_with_created_at do
    summary_template "{{ with index data 0 }}{{ .policy_name }}{{ end }}: {{ len data }} Policy Templates With Lessons Found"
    check eq(val(item, "name"), "")
    escalate $esc_email
    hash_exclude "id"
  end
end
```

## Step 5: Add Detail Template

Every `validate_each` block must contain at least an `export` block or a `detail_template` field. We're going to add a `detail_template` field to replace our `export` block. Add the following `detail_template` field below your `summary_template` field:

```ruby
    detail_template <<-'EOS'
![Flexera](https://github.com/flexera-public/policy_engine_training/blob/main/19_go_template/solution/flexera.png "Flexera")

## {{ len data }} Policy Templates Found

| ID | Name | Category | Lesson | Created At |
| -- | ---- | -------- | ------ | ---------- |
{{ range data -}}
  | {{ .id }} | {{ .name }} | {{ .category }} | {{ .lesson }} | {{ .created_at }} |
{{ end -}}
```

Note the use of "<<-'EOS'" and "EOS"; you can do this anywhere in the policy template language where you need a string to use multiple lines. While the most common use case for this is `script` blocks, it's also useful sometimes for the `detail_template` field.

The first line uses [Markdown to add an image](https://www.codecademy.com/resources/docs/markdown/images) to the top of our detail_template, and the third line uses `##` to emphasize the text.

The fifth and sixth lines will create a [table in Markdown](https://www.codecademy.com/resources/docs/markdown/tables). The columns are defined in the first line and the second line with the combination of `-` and `|` characters is what indicates that this is a table and not just normal text.

Anything between "{{ range data -}}" and "{{ end -}}" will be rendered for each item in the datasource. As a result, we'll get a row in our table for every item.

## Step 6: Testing

Let's verify that none of our changes broke the policy template. Do an fpt check to make sure there are no syntax errors or other code problems:

```bash
fpt check list_policy_templates.pt
```

Once we've verified there are no syntax errors, let's run the policy template:

```bash
fpt run list_policy_templates.pt --credentials="auth_flexera=your_credential_identifier"
```

You should see something very similar to the following:

```text
Summary: List Policy Templates test: 2 Policy Templates With Lessons Found
Detail:
![Flexera](https://github.com/flexera-public/policy_engine_training/blob/main/19_go_template/solution/flexera.png "Flexera")

## 2 Policy Templates Found

| ID | Name | Category | Lesson | Created At |
| -- | ---- | -------- | ------ | ---------- |
| 60170dbd4582b9963de482bd | Hello World | Tutorial | Lesson 02 | 2024-03-25T20:17:19Z |
| 70dbd01b48294b58d963de26 | List Policy Templates | Tutorial | Lesson 06 | 2025-03-06T16:05:08Z |
```

Note how the Go template syntax was replaced with the values we wanted. We're now looking at Markdown-formatted text. This text, when viewed in the Flexera One UI or in an incident email, will be converted to HTML and look something like this:

![Markdown Example](https://github.com/flexera-public/policy_engine_training/blob/main/19_go_template/solution/markdown.png "Markdown Example")

## A Note On HTML

HTML is not legitimately supported by the policy engine and it is not recommended that you put HTML code in your `detail_template` field. *Some* HTML will render correctly when an incident is emailed, but the raw HTML code will be displayed instead when viewing the incident in the Flexera One UI. [Markdown](https://www.markdownguide.org/) should be used instead.

Please proceed to [Lesson 20](https://github.com/flexera-public/policy_engine_training/blob/main/20_further_learning/README.md) for more information on how to learn about the policy engine and policy template language.
